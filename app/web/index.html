<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniDB æµ‹è¯•åº”ç”¨</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ—„ï¸ MiniDB æµ‹è¯•åº”ç”¨</h1>
            <p>æ‡’çŒ«å®˜æ–¹ minidb æ’ä»¶æ–‡æ¡£å¼æ•°æ®åº“åŠŸèƒ½æµ‹è¯•</p>
        </header>

        <div class="control-panel">
            <button id="generateData" class="btn btn-primary">ç”Ÿæˆæµ‹è¯•æ•°æ®</button>
            <button id="clearData" class="btn btn-danger">æ¸…ç†æ•°æ®</button>
            <button id="getAllData" class="btn btn-info">è·å–æ‰€æœ‰æ•°æ®</button>
        </div>

        <div class="test-section">
            <h2>ğŸ“‹ æŸ¥è¯¢åŠŸèƒ½æµ‹è¯•</h2>
            <div class="test-buttons">
                <button id="testInQuery" class="btn btn-test">$in æŸ¥è¯¢æµ‹è¯•</button>
                <button id="testEqQuery" class="btn btn-test">$eq æŸ¥è¯¢æµ‹è¯•</button>
                <button id="testGtQuery" class="btn btn-test">$gt/$gte æŸ¥è¯¢æµ‹è¯•</button>
                <button id="testLtQuery" class="btn btn-test">$lt/$lte æŸ¥è¯¢æµ‹è¯•</button>
                <button id="testRangeQuery" class="btn btn-test">èŒƒå›´æŸ¥è¯¢æµ‹è¯•</button>
                <button id="testExistsQuery" class="btn btn-test">$exists æŸ¥è¯¢æµ‹è¯•</button>
                <button id="testLikeQuery" class="btn btn-test">$like æŸ¥è¯¢æµ‹è¯•</button>
            </div>
        </div>

        <div class="results-section">
            <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
            <div id="results" class="results-container">
                <p class="placeholder">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...</p>
            </div>
        </div>

        <div class="status-section">
            <h2>ğŸ“ˆ çŠ¶æ€ä¿¡æ¯</h2>
            <div id="status" class="status-container">
                <p>åº”ç”¨å·²å°±ç»ªï¼Œç­‰å¾…æ“ä½œ...</p>
            </div>
        </div>
    </div>

    <!-- ä½¿ç”¨ Import Maps é…ç½®æ¨¡å—è·¯å¾„ -->
    <script type="importmap">
    {
        "imports": {
            "@lazycatcloud/minidb": "https://cdn.skypack.dev/@lazycatcloud/minidb"
        }
    }
    </script>

    <script type="module">
        // æŒ‰ç…§å®˜æ–¹æ–‡æ¡£æ­£ç¡®å¯¼å…¥ MiniDB [citation](1)
        import { MiniDB } from "@lazycatcloud/minidb";

        class MiniDBTester {
            constructor() {
                try {
                    // æŒ‰ç…§å®˜æ–¹æ–‡æ¡£åˆå§‹åŒ– [citation](1)
                    this.db = new MiniDB();
                    this.testCollection = this.db.getCollection("minidb_test");
                    this.initEventListeners();
                    this.updateStatus('MiniDB åˆå§‹åŒ–æˆåŠŸï¼Œå‡†å¤‡å¼€å§‹æµ‹è¯•');
                    console.log('MiniDB åˆå§‹åŒ–æˆåŠŸ');
                } catch (error) {
                    console.error('MiniDB åˆå§‹åŒ–å¤±è´¥:', error);
                    this.updateStatus(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                }
            }

            // å®Œå…¨æŒ‰ç…§å®˜æ–¹æ–‡æ¡£ç¤ºä¾‹ç”Ÿæˆæµ‹è¯•æ•°æ® [citation](1)
            async generateTestData() {
                console.log('å¼€å§‹ç”Ÿæˆæµ‹è¯•æ•°æ®...');
                this.updateStatus('æ­£åœ¨ç”Ÿæˆæµ‹è¯•æ•°æ®...');
                
                // ä½¿ç”¨å®˜æ–¹æ–‡æ¡£çš„ç¡®åˆ‡ä»£ç æ ¼å¼ [citation](1)
                const docs = [...Array(100)].map((_, index) => {
                    const doc = {
                        index,
                        name: `name-${index}`,
                    };
                    if (index == 99) {
                        doc.last = true;
                    }
                    return doc;
                });
                
                try {
                    await this.testCollection.upsert(docs);
                    this.updateResults({
                        success: true,
                        message: 'æµ‹è¯•æ•°æ®ç”Ÿæˆå®Œæˆ',
                        count: docs.length,
                        data: docs.slice(0, 5)
                    });
                    this.updateStatus('æµ‹è¯•æ•°æ®ç”ŸæˆæˆåŠŸ');
                } catch (error) {
                    console.error('ç”Ÿæˆæµ‹è¯•æ•°æ®å¤±è´¥:', error);
                    this.updateResults({
                        success: false,
                        message: 'ç”Ÿæˆæµ‹è¯•æ•°æ®å¤±è´¥',
                        error: error.message
                    });
                }
            }

            // $in æŸ¥è¯¢æµ‹è¯• - æŒ‰ç…§å®˜æ–¹æ–‡æ¡£ [citation](1)
            async testInQuery() {
                try {
                    this.updateStatus('æ‰§è¡Œ $in æŸ¥è¯¢æµ‹è¯•...');
                    const result = await this.testCollection
                        .find({ index: { $in: [0, 1, 2, 3, 4, 5] } }, { sort: ["index"] })
                        .fetch();
                    
                    this.updateResults({
                        success: true,
                        message: '$in æŸ¥è¯¢æµ‹è¯•å®Œæˆ',
                        query: 'æŸ¥è¯¢ index åœ¨ [0,1,2,3,4,5] èŒƒå›´å†…çš„æ•°æ®',
                        count: result.length,
                        data: result
                    });
                } catch (error) {
                    this.updateResults({
                        success: false,
                        message: '$in æŸ¥è¯¢å¤±è´¥',
                        error: error.message
                    });
                }
            }

            // $eq æŸ¥è¯¢æµ‹è¯• - æ”¯æŒä¸¤ç§å†™æ³• [citation](1)
            async testEqQuery() {
                try {
                    this.updateStatus('æ‰§è¡Œ $eq æŸ¥è¯¢æµ‹è¯•...');
                    // å®˜æ–¹æ–‡æ¡£æ”¯æŒçš„ä¸¤ç§å†™æ³• [citation](1)
                    const result1 = await this.testCollection.findOne({ index: 5 });
                    const result2 = await this.testCollection.findOne({ index: { $eq: 5 } });
                    
                    this.updateResults({
                        success: true,
                        message: '$eq æŸ¥è¯¢æµ‹è¯•å®Œæˆ',
                        query: 'æŸ¥è¯¢ index ç­‰äº 5 çš„æ•°æ®ï¼ˆä¸¤ç§å†™æ³•ï¼‰',
                        data: { 
                            ç®€åŒ–å†™æ³•: result1, 
                            å®Œæ•´å†™æ³•: result2 
                        }
                    });
                } catch (error) {
                    this.updateResults({
                        success: false,
                        message: '$eq æŸ¥è¯¢å¤±è´¥',
                        error: error.message
                    });
                }
            }

            // $gt å’Œ $gte æŸ¥è¯¢æµ‹è¯• [citation](1)
            async testGtQuery() {
                try {
                    this.updateStatus('æ‰§è¡Œ $gt/$gte æŸ¥è¯¢æµ‹è¯•...');
                    const gtResult = await this.testCollection
                        .find({ index: { $gt: 90 } }, { sort: ["index"] })
                        .fetch();
                        
                    const gteResult = await this.testCollection
                        .find({ index: { $gte: 90 } }, { sort: ["index"] })
                        .fetch();
                    
                    this.updateResults({
                        success: true,
                        message: '$gt å’Œ $gte æŸ¥è¯¢æµ‹è¯•å®Œæˆ',
                        details: {
                            '$gt: 90': `${gtResult.length} æ¡è®°å½•ï¼ˆåº”ä¸º9æ¡ï¼‰`,
                            '$gte: 90': `${gteResult.length} æ¡è®°å½•ï¼ˆåº”ä¸º10æ¡ï¼‰`
                        },
                        data: {
                            gt_results: gtResult,
                            gte_results: gteResult
                        }
                    });
                } catch (error) {
                    this.updateResults({
                        success: false,
                        message: '$gt/$gte æŸ¥è¯¢å¤±è´¥',
                        error: error.message
                    });
                }
            }

            // $lt å’Œ $lte æŸ¥è¯¢æµ‹è¯• [citation](1)
            async testLtQuery() {
                try {
                    this.updateStatus('æ‰§è¡Œ $lt/$lte æŸ¥è¯¢æµ‹è¯•...');
                    const ltResult = await this.testCollection
                        .find({ index: { $lt: 9 } }, { sort: ["index"] })
                        .fetch();
                        
                    const lteResult = await this.testCollection
                        .find({ index: { $lte: 9 } }, { sort: ["index"] })
                        .fetch();
                    
                    this.updateResults({
                        success: true,
                        message: '$lt å’Œ $lte æŸ¥è¯¢æµ‹è¯•å®Œæˆ',
                        details: {
                            '$lt: 9': `${ltResult.length} æ¡è®°å½•ï¼ˆåº”ä¸º9æ¡ï¼‰`,
                            '$lte: 9': `${lteResult.length} æ¡è®°å½•ï¼ˆåº”ä¸º10æ¡ï¼‰`
                        },
                        data: {
                            lt_results: ltResult,
                            lte_results: lteResult
                        }
                    });
                } catch (error) {
                    this.updateResults({
                        success: false,
                        message: '$lt/$lte æŸ¥è¯¢å¤±è´¥',
                        error: error.message
                    });
                }
            }

            // èŒƒå›´æŸ¥è¯¢æµ‹è¯• [citation](1)
            async testRangeQuery() {
                try {
                    this.updateStatus('æ‰§è¡ŒèŒƒå›´æŸ¥è¯¢æµ‹è¯•...');
                    const result = await this.testCollection
                        .find({ index: { $lte: 10, $gte: 5 } }, { sort: ["index"] })
                        .fetch();
                    
                    this.updateResults({
                        success: true,
                        message: 'èŒƒå›´æŸ¥è¯¢æµ‹è¯•å®Œæˆ',
                        query: 'æŸ¥è¯¢ index åœ¨ 5-10 ä¹‹é—´çš„æ•°æ®',
                        count: result.length,
                        expected: 'åº”ä¸º6æ¡è®°å½•',
                        data: result
                    });
                } catch (error) {
                    this.updateResults({
                        success: false,
                        message: 'èŒƒå›´æŸ¥è¯¢å¤±è´¥',
                        error: error.message
                    });
                }
            }

            // $exists æŸ¥è¯¢æµ‹è¯• [citation](1)
            async testExistsQuery() {
                try {
                    this.updateStatus('æ‰§è¡Œ $exists æŸ¥è¯¢æµ‹è¯•...');
                    const result = await this.testCollection
                        .find({ $exists: "last" }, { sort: ["index"] })
                        .fetch();
                    
                    this.updateResults({
                        success: true,
                        message: '$exists æŸ¥è¯¢æµ‹è¯•å®Œæˆ',
                        query: 'æŸ¥è¯¢å­˜åœ¨ last å­—æ®µçš„æ•°æ®',
                        count: result.length,
                        expected: 'åº”ä¸º1æ¡è®°å½•ï¼ˆindex=99ï¼‰',
                        data: result
                    });
                } catch (error) {
                    this.updateResults({
                        success: false,
                        message: '$exists æŸ¥è¯¢å¤±è´¥',
                        error: error.message
                    });
                }
            }

            // $like æŸ¥è¯¢æµ‹è¯• [citation](1)
            async testLikeQuery() {
                try {
                    this.updateStatus('æ‰§è¡Œ $like æŸ¥è¯¢æµ‹è¯•...');
                    const simpleResult = await this.testCollection
                        .find({ name: { $like: `name-1` } }, { sort: ["index"] })
                        .fetch();
                        
                    const regexResult = await this.testCollection
                        .find({ name: { $like: `name-1[5678]` } }, { sort: ["index"] })
                        .fetch();
                    
                    this.updateResults({
                        success: true,
                        message: '$like æŸ¥è¯¢æµ‹è¯•å®Œæˆ',
                        details: {
                            'ç®€å•æ¨¡ç³ŠæŸ¥è¯¢ "name-1"': `${simpleResult.length} æ¡è®°å½•ï¼ˆåº”ä¸º11æ¡ï¼‰`,
                            'æ­£åˆ™è¡¨è¾¾å¼æŸ¥è¯¢ "name-1[5678]"': `${regexResult.length} æ¡è®°å½•ï¼ˆåº”ä¸º4æ¡ï¼‰`
                        },
                        data: {
                            simple_results: simpleResult.slice(0, 5),
                            regex_results: regexResult
                        }
                    });
                } catch (error) {
                    this.updateResults({
                        success: false,
                        message: '$like æŸ¥è¯¢å¤±è´¥',
                        error: error.message
                    });
                }
            }

            // è·å–æ‰€æœ‰æ•°æ®
            async getAllData() {
                try {
                    this.updateStatus('è·å–æ‰€æœ‰æ•°æ®...');
                    const result = await this.testCollection
                        .find({}, { sort: ["index"] })
                        .fetch();
                    
                    this.updateResults({
                        success: true,
                        message: 'è·å–æ‰€æœ‰æ•°æ®æˆåŠŸ',
                        count: result.length,
                        data: result.slice(0, 10)
                    });
                } catch (error) {
                    this.updateResults({
                        success: false,
                        message: 'è·å–æ•°æ®å¤±è´¥',
                        error: error.message
                    });
                }
            }

            // æ¸…ç†æµ‹è¯•æ•°æ® [citation](1)
            async clearData() {
                try {
                    this.updateStatus('æ¸…ç†æµ‹è¯•æ•°æ®...');
                    await this.db.removeCollection("minidb_test");
                    this.updateResults({
                        success: true,
                        message: 'æµ‹è¯•æ•°æ®æ¸…ç†å®Œæˆ'
                    });
                    this.updateStatus('æ•°æ®å·²æ¸…ç†');
                } catch (error) {
                    this.updateResults({
                        success: false,
                        message: 'æ¸…ç†æ•°æ®å¤±è´¥',
                        error: error.message
                    });
                }
            }

            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
            initEventListeners() {
                document.getElementById('generateData').addEventListener('click', () => this.generateTestData());
                document.getElementById('clearData').addEventListener('click', () => this.clearData());
                document.getElementById('getAllData').addEventListener('click', () => this.getAllData());
                document.getElementById('testInQuery').addEventListener('click', () => this.testInQuery());
                document.getElementById('testEqQuery').addEventListener('click', () => this.testEqQuery());
                document.getElementById('testGtQuery').addEventListener('click', () => this.testGtQuery());
                document.getElementById('testLtQuery').addEventListener('click', () => this.testLtQuery());
                document.getElementById('testRangeQuery').addEventListener('click', () => this.testRangeQuery());
                document.getElementById('testExistsQuery').addEventListener('click', () => this.testExistsQuery());
                document.getElementById('testLikeQuery').addEventListener('click', () => this.testLikeQuery());
            }

            // æ›´æ–°ç»“æœæ˜¾ç¤º
            updateResults(result) {
                const resultsContainer = document.getElementById('results');
                const resultItem = document.createElement('div');
                resultItem.className = `result-item ${result.success ? '' : 'error'}`;
                
                let content = `<h3>${result.message}</h3>`;
                if (result.query) content += `<p><strong>æŸ¥è¯¢:</strong> ${result.query}</p>`;
                if (result.count !== undefined) content += `<p><strong>ç»“æœæ•°é‡:</strong> ${result.count}</p>`;
                if (result.expected) content += `<p><strong>é¢„æœŸ:</strong> ${result.expected}</p>`;
                if (result.details) {
                    content += '<p><strong>è¯¦ç»†ä¿¡æ¯:</strong></p><ul>';
                    Object.entries(result.details).forEach(([key, value]) => {
                        content += `<li>${key}: ${value}</li>`;
                    });
                    content += '</ul>';
                }
                if (result.error) content += `<p><strong>é”™è¯¯:</strong> ${result.error}</p>`;
                if (result.data) content += `<div class="data-preview">${JSON.stringify(result.data, null, 2)}</div>`;
                
                resultItem.innerHTML = content;
                resultsContainer.appendChild(resultItem);
                resultsContainer.scrollTop = resultsContainer.scrollHeight;
            }

            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            updateStatus(message) {
                const statusContainer = document.getElementById('status');
                const timestamp = new Date().toLocaleTimeString();
                statusContainer.innerHTML = `<p>[${timestamp}] ${message}</p>`;
            }
        }

        // ç­‰å¾…DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            const tester = new MiniDBTester();
            console.log('MiniDB æµ‹è¯•åº”ç”¨å·²åˆå§‹åŒ–');
        });
    </script>
</body>
</html>